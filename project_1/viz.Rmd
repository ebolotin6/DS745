---
title: "project_1"
author: "Eli (Ilya) Bolotin"
date: "9/19/2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load libraries

```{r message=FALSE, warning=FALSE}
library(ggplot2)
library(dplyr)
library(reshape)
library(ggrepel)
```

## Load and transform data
```{r message=FALSE, warning=FALSE}
# Load data
world_stats <- read.csv("data.csv")

# Drop some columns, rows
world_stats <- select(world_stats, -c(Series.Code, Country.Code))
world_stats <- world_stats[-c((nrow(world_stats)-5):nrow(world_stats)),]

# Rename year columns
cols_containing_x <- names(world_stats[, grepl( "X" , names(world_stats) )])
new_names <- substring(cols_containing_x, 2, 5)
colnames(world_stats)[colnames(world_stats) %in% cols_containing_x] <- new_names

# Reshape data
md <- melt(world_stats, id=(c("Country.Name","Series.Name")))
world_stats <- cast(md, "Country.Name+variable~Series.Name")
world_stats <- world_stats[,-c(5,12:16)]

# rename metrics
colnames(world_stats)[c(2,3,4,5,6,7,8,9,10,11)] <- c("year","adolescent_fertility","gdp","life_expectancy","mortality_rate","net_migration","prem","pop_growth","pop_total","surface_area")

# convert cols to numeric
world_stats$gdp <- as.numeric(levels(world_stats$gdp))[world_stats$gdp]
world_stats$mortality_rate <- as.numeric(levels(world_stats$mortality_rate))[world_stats$mortality_rate]

world_stats$gdp <- world_stats$gdp/(1000000000)
```

## Add corruption index to data

```{r}
# create corruption index lookup table
ci_df <- read.csv("cpi.csv", sep=";")
ci_df <- ci_df[,-c(1,2,4,7)]
ci_df <- ci_df[ci_df$time==2018,c(1,3)]
colnames(ci_df) <- c("Country.Name","cpi")
ci_df$Country.Name <- as.character(ci_df$Country.Name)

# synchronize names between tables
countries <- levels(droplevels(world_stats$Country.Name))

for(country in countries) {
  j = agrep(country, ci_df$Country.Name, ignore.case = FALSE, value = FALSE, max.distance = 0.1)
  if(length(j) == 1) {
    levels(world_stats$Country.Name)[levels(world_stats$Country.Name) == country] <- ci_df$Country.Name[j]
  }
}
```

## Add categorical features

```{r message=FALSE, warning=FALSE}
world_stats <- full_join(world_stats, ci_df, by = "Country.Name")

# update world stats table with corruption level
world_stats <- world_stats %>% mutate(ci_rating = case_when(
                                      cpi >= 120  ~ "very corrupt",
                                      cpi < 120 & cpi >= 90 ~ "corrupt",
                                      cpi < 90 & cpi >= 50 ~ "somewhat corrupt",
                                      cpi < 50 & cpi >= 25 ~ "clean",
                                      cpi < 25 ~ "very clean"))

world_stats <- world_stats %>% mutate(mortality_cat = case_when(
                                      mortality_rate <= 15 ~ "low",
                                      mortality_rate > 15 & mortality_rate <= 30 ~ "medium",
                                      mortality_rate > 30 ~ "high"))

# drop NAs
world_stats <- world_stats[which(!is.na(world_stats$gdp) & !is.na(world_stats$cpi) & !is.na(world_stats$mortality_cat)),]

# create df for 2018
world_stats_2018 = world_stats[world_stats$year==2018,]
world_stats_2018$ci_rating <- factor(world_stats_2018$ci_rating, levels = c("very clean", "clean", "somewhat corrupt", "corrupt", "very corrupt"))
```

## Graph 1

```{r}
ggplot(data = world_stats_2018)+
  geom_point(aes(x=cpi, y=mortality_rate, fill=gdp)) + 
  scale_x_continuous(labels = scales::comma)
```

## Graph 2

```{r}
p <- ggplot(data = world_stats_2018, aes(x=cpi, y=mortality_rate))
p + geom_point(aes(colour = factor(ci_rating)), size = 4) +
  geom_point(colour = "grey90", size = 1.5) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))
```

## Graph 3

```{r}
p <- ggplot(data = world_stats_2018, aes(x=cpi, y=mortality_rate))
p + geom_point(aes(colour = factor(ci_rating)), size = 4) +
  scale_colour_brewer(palette = "RdYlGn", direction=-1, name = "Corruption Level", labels = c("very clean", "clean", "somewhat corrupt", "corrupt", "very corrupt")) +
  geom_point(colour = "grey90", size = .1) +
  geom_text_repel(
    data = subset(world_stats_2018, gdp >= 4000), 
    aes(label=Country.Name),
    nudge_y      = 45,
    direction    = "both",
    angle        = 0,
    segment.color = "grey88",
    segment.size = .2,
    segment.alpha = .9,
    size = 3.5,
    vjust        = 0) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))
```







